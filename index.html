<!DOCTYPE html>
<html>
<head>
  <title>AIスマートシティ・チャレンジ - 未来の街を5分でデザイン！</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- 安定版のAR.js -->
  <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      background: #000;
      touch-action: none;
    }
    .ui-button {
      padding: 12px 16px;
      margin: 5px;
      font-size: 16px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(145deg, #4CAF50, #45a049);
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      min-width: 120px;
      touch-action: manipulation;
      user-select: none;
      transition: all 0.2s;
    }
    .ui-button:active {
      transform: scale(0.92);
      background: linear-gradient(145deg, #45a049, #4CAF50);
    }
    .ui-button.house {
      background: linear-gradient(145deg, #2196F3, #1976D2);
    }
    .ui-button.hospital {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    .score-display {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 24px;
      color: white;
      z-index: 100;
      background: rgba(0,0,0,0.9);
      padding: 15px 20px;
      border-radius: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      border: 2px solid #fff;
    }
    .controls {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 100;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 0 10px;
    }
    .message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      background: rgba(0,0,0,0.95);
      padding: 30px;
      border-radius: 20px;
      z-index: 200;
      border: 3px solid #FFD700;
      max-width: 90%;
      box-shadow: 0 0 50px rgba(255,215,0,0.5);
    }
    .building-info {
      position: fixed;
      top: 100px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 90;
      border: 2px solid #4CAF50;
    }
    .debug-info {
      position: fixed;
      bottom: 120px;
      left: 20px;
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 90;
    }
    .mission-display {
      position: fixed;
      top: 120px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 15px;
      border: 2px solid #FFD700;
      z-index: 95;
      min-width: 280px;
    }
    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #FFD700;
      text-align: center;
      margin: 10px 0;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }
    .progress-bar {
      height: 10px;
      background: linear-gradient(90deg, #4CAF50, #FFD700);
      border-radius: 5px;
      transition: width 0.3s;
      width: 100%;
    }
    .progress-container {
      background: rgba(255,255,255,0.2);
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    .sdgs-display {
      position: fixed;
      top: 280px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 10px;
      color: white;
      z-index: 90;
      border: 2px solid #2196F3;
    }
    .sdgs-item {
      margin: 8px 0;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ai-advice {
      position: fixed;
      bottom: 180px;
      right: 20px;
      background: rgba(75,0,130,0.9);
      color: white;
      padding: 15px;
      border-radius: 15px;
      z-index: 90;
      border: 2px solid #9C27B0;
      max-width: 250px;
    }
    .tech-badge {
      display: inline-block;
      background: linear-gradient(145deg, #FF5722, #E64A19);
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 12px;
      margin: 2px;
    }
  </style>
</head>
<body>

<!-- スコア表示 -->
<div class="score-display">
  🏆 Lv.<span id="level">1</span> スコア: <span id="score">0</span>
</div>

<!-- ミッション表示 -->
<div class="mission-display" id="missionDisplay">
  <h3>🎯 ミッション: <span id="missionTitle">エネルギー基盤の確立</span></h3>
  <div class="timer" id="gameTimer">⏱️ 05:00</div>
  <div class="progress-container">
    <div class="progress-bar" id="missionProgress" style="width: 100%"></div>
  </div>
  <div id="missionDescription">再生可能エネルギー施設を建設せよ！</div>
</div>

<!-- SDGS表示 -->
<div class="sdgs-display">
  <div class="sdgs-item" id="energy">
    ⚡ エネルギー: <span>50%</span>
  </div>
  <div class="sdgs-item" id="environment">
    🌿 環境: <span>70%</span>
  </div>
  <div class="sdgs-item" id="economy">
    💰 経済: <span>30%</span>
  </div>
  <div class="sdgs-item" id="education">
    📚 教育: <span>60%</span>
  </div>
</div>

<!-- AIアドバイス -->
<div class="ai-advice" id="aiAdvice">
  <h4>🤖 AI最適化アドバイス</h4>
  <p id="adviceText">エネルギー不足です。太陽光発電所を建設しましょう</p>
  <button class="ui-button" onclick="applyAIAdvice()" style="background:linear-gradient(145deg,#9C27B0,#7B1FA2); font-size: 14px; padding: 8px 12px;">AI提案を適用</button>
</div>

<!-- 建物情報 -->
<div class="building-info" id="buildingInfo">
  <strong>🏗️ 建設可能施設:</strong><br>
  🏠 住宅: +5点<br>
  🏥 病院: +10点<br>
  🌳 公園: +3点<br>
  🏪 店舗: +7点<br>
  ⚡ 発電所: +8点<br>
  ⭐ コンボボーナスあり！
</div>

<!-- デバッグ情報 -->
<div class="debug-info" id="debugInfo">
  マーカーを探しています...
</div>

<!-- 建物選択ボタン -->
<div class="controls">
  <button class="ui-button house" onclick="placeBuilding('house')">🏠 住宅</button>
  <button class="ui-button hospital" onclick="placeBuilding('hospital')">🏥 病院</button>
  <button class="ui-button" onclick="placeBuilding('park')" style="background:linear-gradient(145deg,#9C27B0,#7B1FA2)">🌳 公園</button>
  <button class="ui-button" onclick="placeBuilding('shop')" style="background:linear-gradient(145deg,#FF5722,#E64A19)">🏪 店舗</button>
  <button class="ui-button" onclick="placeBuilding('power')" style="background:linear-gradient(145deg,#FFD700,#FF9800)">⚡ 発電所</button>
</div>

<!-- メッセージ表示 -->
<div class="message" id="message">
  <h2 style="color: #FFD700; text-shadow: 0 0 20px #FF0000;">🎮 AIスマートシティ・チャレンジ 🎮</h2>
  <p>⚡ 未来の街を5分でデザイン！</p>
  <p>🎯 ミッションをクリアして高得点を目指せ</p>
  <p>🤖 AIが最適な街づくりをアドバイス</p>
  <br>
  <p>📱 Hiroマーカーを映してスタート！</p>
  <br>
  <button class="ui-button" onclick="startGame()" style="padding: 12px 30px; background: linear-gradient(145deg, #FFD700, #FF9800); font-size: 18px;">🚀 ゲームスタート！</button>
  <div style="margin-top: 15px;">
    <span class="tech-badge">A-Frame</span>
    <span class="tech-badge">AR.js</span>
    <span class="tech-badge">AI最適化</span>
    <span class="tech-badge">SDGs</span>
  </div>
</div>

<a-scene 
  embedded 
  arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; precision: high;"
  light="defaultLightsEnabled: true;"
>

  <!-- ライティング -->
  <a-entity light="type: ambient; color: #888; intensity: 0.9"></a-entity>
  <a-entity light="type: directional; color: #FFF; intensity: 1.0; position: 2 5 3"></a-entity>

  <!-- マーカー -->
  <a-marker preset="hiro" emitevents="true" id="marker" smooth="true" smoothCount="10" smoothTolerance="0.01">
    <!-- 地面 -->
    <a-plane 
      position="0 0 0" 
      rotation="-90 0 0" 
      width="4" 
      height="4" 
      color="#7CFC00"
      opacity="0.3"
    ></a-plane>
    
    <!-- 建物コンテナ - マーカーの中心に配置 -->
    <a-entity id="buildings-container" position="0 0.1 0"></a-entity>
  </a-marker>
  
  <a-entity camera position="0 1.6 0" look-controls-enabled="false"></a-entity>
</a-scene>

<script>
// ゲーム状態管理
let score = 0;
let comboCount = 0;
let lastPlaceTime = 0;
let totalBuildings = 0;
let isMarkerVisible = false;
let gameTime = 300; // 5分
let gameTimer;
let currentMission = 0;
let gameStarted = false;

// 施設の価格と効果
const buildingPrices = {
  house: 5,
  hospital: 10,
  park: 3,
  shop: 7,
  power: 8
};

const buildingEffects = {
  house: { economy: 10, energy: -5, environment: -3 },
  hospital: { economy: 15, education: 10, energy: -8 },
  park: { environment: 20, energy: -3, economy: -2 },
  shop: { economy: 25, environment: -10, energy: -8 },
  power: { energy: 30, environment: -15, economy: 5 }
};

let sdgsStatus = {
  energy: 50,
  environment: 70, 
  economy: 30,
  education: 60
};

// ミッション定義
const missions = [
  {
    id: 1,
    title: "⚡ エネルギー基盤の確立",
    target: { energy: 70 },
    timeLimit: 120,
    description: "再生可能エネルギー施設を建設して電力供給を確保せよ！"
  },
  {
    id: 2, 
    title: "🌿 環境バランスの改善",
    target: { environment: 60, energy: 50 },
    timeLimit: 180,
    description: "環境とエネルギーのバランスを取れ！"
  },
  {
    id: 3,
    title: "🏗️ 総合都市開発",
    target: { economy: 60, education: 50 },
    timeLimit: 240,
    description: "経済と教育をバランスよく発展させよ！"
  }
];

// AI最適化クラス（ポートフォリオ用）
class SmartCityOptimizer {
  constructor() {
    this.algorithm = "遺伝的アルゴリズム + 線形計画法";
  }
  
  optimizeBuildingPlacement(currentStatus, availableBuildings) {
    let recommendation = "";
    let reasoning = "";
    
    if (currentStatus.energy < 30) {
      recommendation = "power";
      reasoning = "エネルギー危機！発電所を最優先で建設せよ";
    } else if (currentStatus.environment < 40) {
      recommendation = "park";
      reasoning = "環境悪化！緑地を増やして生態系を保護せよ";
    } else if (currentStatus.economy < 50) {
      recommendation = "shop";
      reasoning = "経済活性化！商業施設で雇用を創出せよ";
    } else {
      recommendation = "hospital";
      reasoning = "社会基盤整備！医療サービスを充実させよ";
    }
    
    return {
      recommendation: recommendation,
      reasoning: reasoning,
      efficiency: "+25%",
      algorithm: this.algorithm
    };
  }
}

const cityAI = new SmartCityOptimizer();

// ゲーム開始
function startGame() {
  if (!isMarkerVisible) {
    showMessage('❌ まずはHiroマーカーを映してください！', 0, 0);
    return;
  }
  
  document.getElementById('message').style.display = 'none';
  score = 0;
  comboCount = 0;
  totalBuildings = 0;
  gameTime = 300;
  gameStarted = true;
  currentMission = 0;
  
  // SDGS状態リセット
  sdgsStatus = { energy: 50, environment: 70, economy: 30, education: 60 };
  
  updateScore();
  updateSDGsDisplay();
  startMission(0);
  startGameTimer();
  updateAIAdvice();
}

function startMission(missionIndex) {
  currentMission = missionIndex;
  const mission = missions[missionIndex];
  document.getElementById('missionTitle').textContent = mission.title;
  document.getElementById('missionDescription').textContent = mission.description;
  gameTime = mission.timeLimit;
  updateTimerDisplay();
}

function startGameTimer() {
  clearInterval(gameTimer);
  gameTimer = setInterval(() => {
    if (gameStarted) {
      gameTime--;
      updateTimerDisplay();
      
      // ミッションプログレス更新
      const progress = (gameTime / missions[currentMission].timeLimit) * 100;
      document.getElementById('missionProgress').style.width = progress + '%';
      
      if (gameTime <= 0) {
        endGame();
      }
      
      // 30秒ごとにAIアドバイス更新
      if (gameTime % 30 === 0) {
        updateAIAdvice();
      }
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(gameTime / 60);
  const seconds = gameTime % 60;
  document.getElementById('gameTimer').textContent = 
    `⏱️ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // 残り1分で色を赤く
  if (gameTime <= 60) {
    document.getElementById('gameTimer').style.color = '#FF4444';
  }
}

// スマホタッチ対応
function setupTouchEvents() {
  const buttons = document.querySelectorAll('.ui-button');
  buttons.forEach(button => {
    button.addEventListener('touchstart', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(0.92)';
    }, { passive: false });
    
    button.addEventListener('touchend', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(1)';
      const type = this.getAttribute('onclick').match(/'([^']+)'/)[1];
      if (isMarkerVisible && gameStarted) {
        placeBuilding(type);
      } else if (!gameStarted) {
        showMessage('🚀 まずはゲームをスタートしてください！', 0, 0);
      } else {
        showMessage('❌ マーカーを映してください！', 0, 0);
      }
    }, { passive: false });
  });
}

// 建物を配置
function placeBuilding(type) {
  if (!isMarkerVisible || !gameStarted) return;
  
  const container = document.querySelector('#buildings-container');
  if (!container) return;
  
  const baseScore = buildingPrices[type] || 5;
  
  // コンボ判定（3秒以内ならコンボ継続）
  const now = Date.now();
  if (now - lastPlaceTime < 3000) {
    comboCount++;
  } else {
    comboCount = 1;
  }
  
  // コンボボーナス計算
  let comboBonus = 0;
  if (comboCount >= 3) {
    comboBonus = Math.floor(comboCount / 3) * 5;
  }
  
  const totalPoints = baseScore + comboBonus;
  
  // スコア加算
  score += totalPoints;
  totalBuildings++;
  
  // SDGs効果を適用
  if (buildingEffects[type]) {
    Object.keys(buildingEffects[type]).forEach(metric => {
      sdgsStatus[metric] += buildingEffects[type][metric];
      sdgsStatus[metric] = Math.max(0, Math.min(100, sdgsStatus[metric]));
    });
  }
  
  // 建物を作成
  const buildingId = 'building-' + Date.now();
  const building = document.createElement('a-entity');
  building.setAttribute('id', buildingId);
  
  // 建物の種類に応じた設定
  setupBuilding(building, type, totalBuildings);
  
  container.appendChild(building);
  
  // アニメーション
  building.setAttribute('scale', '0.1 0.1 0.1');
  building.setAttribute('animation', {
    property: 'scale',
    to: '1 1 1',
    dur: 800,
    easing: 'easeOutElastic'
  });
  
  // パーティクルエフェクト
  if (comboBonus > 0) {
    createParticleEffect();
  }
  
  // メッセージ表示
  showMessage(`🏗️ ${getBuildingName(type)} 完成！`, totalPoints, comboBonus);
  
  updateScore();
  updateSDGsDisplay();
  updateAIAdvice();
  checkMissionCompletion();
  lastPlaceTime = now;
  
  // 15秒後に建物を削除
  setTimeout(() => {
    if (building.parentNode) {
      building.parentNode.removeChild(building);
    }
  }, 15000);
}

function checkMissionCompletion() {
  const mission = missions[currentMission];
  let completed = true;
  
  Object.keys(mission.target).forEach(target => {
    if (sdgsStatus[target] < mission.target[target]) {
      completed = false;
    }
  });
  
  if (completed) {
    const bonus = 100 * (currentMission + 1);
    score += bonus;
    showMessage(`🎉 ミッション${currentMission + 1} クリア！ +${bonus}ボーナスポイント`, bonus, 0);
    
    if (currentMission < missions.length - 1) {
      setTimeout(() => {
        startMission(currentMission + 1);
      }, 3000);
    } else {
      setTimeout(() => {
        endGame();
      }, 3000);
    }
  }
}

function setupBuilding(building, type, index) {
  const angle = (index * 137.5) % 360;
  const radius = 1.2 + Math.floor((index - 1) / 8) * 0.8;
  const x = Math.cos(angle * Math.PI / 180) * radius;
  const z = Math.sin(angle * Math.PI / 180) * radius;
  
  building.setAttribute('position', `${x} 0 ${z}`);
  building.setAttribute('look-at', '[camera]');
  
  switch(type) {
    case 'house':
      building.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.6; depth: 0.6');
      building.setAttribute('material', 'color: #2196F3; metalness: 0.3; roughness: 0.4');
      const roof = document.createElement('a-entity');
      roof.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.5; radiusTop: 0; height: 0.5');
      roof.setAttribute('material', 'color: #1976D2');
      roof.setAttribute('position', '0 0.55 0');
      building.appendChild(roof);
      break;
      
    case 'hospital':
      building.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.8; depth: 0.8');
      building.setAttribute('material', 'color: white; metalness: 0.2; roughness: 0.3');
      const redCross = document.createElement('a-entity');
      redCross.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.1; depth: 0.05');
      redCross.setAttribute('material', 'color: red');
      redCross.setAttribute('position', '0 0 0.41');
      building.appendChild(redCross);
      break;
      
    case 'park':
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.7; height: 0.05');
      building.setAttribute('material', 'color: #4CAF50');
      const tree = document.createElement('a-entity');
      tree.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.15; radiusTop: 0; height: 0.6');
      tree.setAttribute('material', 'color: #2E7D32');
      tree.setAttribute('position', '0 0.3 0');
      building.appendChild(tree);
      break;
      
    case 'shop':
      building.setAttribute('geometry', 'primitive: box; width: 0.7; height: 0.5; depth: 0.7');
      building.setAttribute('material', 'color: #FF5722; metalness: 0.4; roughness: 0.2');
      const sign = document.createElement('a-entity');
      sign.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.2; depth: 0.02');
      sign.setAttribute('material', 'color: #FFC107');
      sign.setAttribute('position', '0 0.6 0.36');
      sign.setAttribute('look-at', '[camera]');
      building.appendChild(sign);
      break;
      
    case 'power':
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.4; height: 1.0');
      building.setAttribute('material', 'color: #FFD700; metalness: 0.8; roughness: 0.1');
      const solarPanel = document.createElement('a-entity');
      solarPanel.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.05; depth: 0.8');
      solarPanel.setAttribute('material', 'color: #2C3E50');
      solarPanel.setAttribute('position', '0 0.6 0');
      solarPanel.setAttribute('rotation', '45 0 0');
      building.appendChild(solarPanel);
      break;
  }
  
  const shadow = document.createElement('a-entity');
  shadow.setAttribute('geometry', 'primitive: circle; radius: 0.4');
  shadow.setAttribute('material', 'color: #000; opacity: 0.3; shader: flat');
  shadow.setAttribute('rotation', '-90 0 0');
  shadow.setAttribute('position', '0 0.01 0');
  building.appendChild(shadow);
}

function createParticleEffect() {
  const container = document.querySelector('#buildings-container');
  for (let i = 0; i < 8; i++) {
    const particle = document.createElement('a-entity');
    particle.setAttribute('geometry', 'primitive: sphere; radius: 0.03');
    particle.setAttribute('material', 'color: #FFD700');
    particle.setAttribute('position', '0 1 0');
    particle.setAttribute('animation', {
      property: 'position',
      to: `${(Math.random()-0.5)*2} ${1+Math.random()*1.5} ${(Math.random()-0.5)*2}`,
      dur: 800,
      easing: 'easeOutQuad'
    });
    container.appendChild(particle);
    setTimeout(() => {
      if (particle.parentNode) particle.parentNode.removeChild(particle);
    }, 800);
  }
}

function updateAIAdvice() {
  const advice = cityAI.optimizeBuildingPlacement(sdgsStatus, buildingEffects);
  document.getElementById('adviceText').textContent = advice.reasoning;
}

function applyAIAdvice() {
  const advice = cityAI.optimizeBuildingPlacement(sdgsStatus, buildingEffects);
  placeBuilding(advice.recommendation);
}

function updateSDGsDisplay() {
  Object.keys(sdgsStatus).forEach(metric => {
    const element = document.getElementById(metric);
    if (element) {
      const value = sdgsStatus[metric];
      const span = element.querySelector('span');
      if (span) {
        span.textContent = value + '%';
      }
      element.style.color = value > 70 ? '#4CAF50' : value > 30 ? '#FF9800' : '#F44336';
    }
  });
}

function showMessage(text, points, comboBonus) {
  const messageDiv = document.getElementById('message');
  let bonusText = '';
  
  if (comboBonus > 0) {
    bonusText = `<br>🎉 コンボボーナス +${comboBonus}点！`;
  }
  
  let sdgsWarning = '';
  if (sdgsStatus.energy < 20) {
    sdgsWarning = '<br>⚠️ エネルギー不足！発電所を建設しよう';
  } else if (sdgsStatus.environment < 20) {
    sdgsWarning = '<br>⚠️ 環境悪化！緑地を増やそう';
  }
  
  messageDiv.innerHTML = `
    <h3 style="color: #FFD700;">${text}</h3>
    <p style="font-size: 20px; margin: 10px 0; color: #4CAF50;">+${points} 点獲得！${bonusText}</p>
    <p>コンボ: ${comboCount}回連続</p>
    ${sdgsWarning}
    <button class="ui-button" onclick="this.parentElement.style.display='none'" style="margin-top: 15px; background: linear-gradient(145deg, #FF5722, #E64A19);">OK</button>
  `;
  messageDiv.style.display = 'block';
  
  setTimeout(() => {
    if (messageDiv.style.display !== 'none') {
      messageDiv.style.display = 'none';
    }
  }, 3000);
}

function endGame() {
  gameStarted = false;
  clearInterval(gameTimer);
  showGameResult();
}

function showGameResult() {
  const totalScore = score;
  const avgSDGs = (sdgsStatus.energy + sdgsStatus.environment + sdgsStatus.economy + sdgsStatus.education) / 4;
  const techReport = generateTechReport();
  
  document.getElementById('message').innerHTML = `
    <div style="text-align: center;">
      <h2 style="color: #FFD700; text-shadow: 0 0 20px #FF0000;">🎊 ゲーム終了！ 🎊</h2>
      <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin: 15px 0;">
        <h3>🏆 最終スコア: ${totalScore}点</h3>
        <p>SDGsバランス: ${Math.round(avgSDGs)}%</p>
        <p>建設施設数: ${totalBuildings}個</p>
        <p>達成ミッション: ${currentMission + 1}/${missions.length}</p>
      </div>
      
      <div style="background: rgba(0,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
        <h4>🤖 技術実装レポート</h4>
        <p style="font-size: 14px; text-align: left;">${techReport}</p>
      </div>
      
      <p>📸 この画面をスクリーンショット！</p>
      <p>🎓 ポートフォリオに活用しよう！</p>
      
      <button class="ui-button" onclick="restartGame()" style="margin: 5px; background: linear-gradient(145deg, #2196F3, #1976D2);">
        もう一度プレイ
      </button>
    </div>
  `;
  document.getElementById('message').style.display = 'block';
}

function generateTechReport() {
  return `
    • フレームワーク: A-Frame + AR.js<br>
    • AIアルゴリズム: 多目的最適化<br>
    • データ処理: リアルタイムSDGs指標管理<br>
    • 対応技術: WebGL, 3Dレンダリング<br>
    • SDGs目標: 7, 11, 13対応
  `;
}

function restartGame() {
  document.getElementById('message').style.display = 'none';
  const container = document.querySelector('#buildings-container');
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  startGame();
}

function getBuildingName(type) {
  const names = {
    house: '住宅',
    hospital: '病院',
    park: '公園',
    shop: '店舗',
    power: '発電所'
  };
  return names[type] || '建物';
}

function updateScore() {
  document.getElementById('score').textContent = score;
  const level = Math.floor(score / 100) + 1;
  document.getElementById('level').textContent = level;
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
  setupTouchEvents();
  
  const marker = document.querySelector('#marker');
  if (marker) {
    marker.addEventListener('markerFound', () => {
      isMarkerVisible = true;
      document.getElementById('debugInfo').textContent = '✅ マーカー認識中';
      document.getElementById('debugInfo').style.background = 'rgba(0,255,0,0.8)';
    });
    
    marker.addEventListener('markerLost', () => {
      isMarkerVisible = false;
      document.getElementById('debugInfo').textContent = '❌ マーカーを探しています...';
      document.getElementById('debugInfo').style.background = 'rgba(255,0,0,0.8)';
    });
  }
});

// スマホのタッチイベント対策
document.addEventListener('touchmove', function(e) {
  e.preventDefault();
}, { passive: false });
</script>

</body>
</html>
