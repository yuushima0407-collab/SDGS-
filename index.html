<!DOCTYPE html>
<html>
<head>
  <title>AIã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£ãƒ»ãƒãƒ£ãƒ¬ãƒ³ã‚¸ - æœªæ¥ã®è¡—ã‚’5åˆ†ã§ãƒ‡ã‚¶ã‚¤ãƒ³ï¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      background: #000;
      touch-action: none;
    }
    .ui-button {
      padding: 15px 20px;
      margin: 8px;
      font-size: 16px;
      border: none;
      border-radius: 15px;
      background: linear-gradient(145deg, #2196F3, #1976D2);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      touch-action: manipulation;
      user-select: none;
      transition: all 0.2s;
      min-width: 100px;
    }
    .ui-button:active {
      transform: scale(0.95);
    }
    .ui-button.hospital {
      background: linear-gradient(145deg, #4CAF50, #45a049);
    }
    .ui-button.park {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    .ui-button.shop {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    .ui-button.power {
      background: linear-gradient(145deg, #FFD700, #FFC107);
    }
    .ui-button.ai {
      background: linear-gradient(145deg, #E91E63, #C2185B);
    }
    .score-display {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 24px;
      color: white;
      z-index: 100;
      background: rgba(0,0,0,0.9);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #fff;
    }
    .controls {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 100;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 0 10px;
    }
    .message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      background: rgba(0,0,0,0.95);
      padding: 30px;
      border-radius: 20px;
      z-index: 200;
      border: 3px solid #FFD700;
      max-width: 90%;
    }
    .sdgs-display {
      position: fixed;
      top: 100px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      padding: 15px;
      border-radius: 10px;
      color: white;
      z-index: 90;
      border: 2px solid #4CAF50;
    }
    .sdgs-item {
      margin: 8px 0;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      min-width: 150px;
    }
    .mission-display {
      position: fixed;
      top: 250px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #FF9800;
      z-index: 90;
      min-width: 280px;
    }
    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #FFD700;
      text-align: center;
      margin: 10px 0;
    }
    .debug-info {
      position: fixed;
      bottom: 120px;
      left: 20px;
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 90;
    }
    .combo-display {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255,215,0,0.9);
      color: black;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      z-index: 100;
      display: none;
    }
    .ai-dashboard {
      position: fixed;
      top: 400px;
      left: 20px;
      background: rgba(75,0,130,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #9C27B0;
      z-index: 90;
      min-width: 280px;
    }
    .ai-metric {
      margin: 5px 0;
      font-size: 13px;
      padding: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
    }
    .tech-badge {
      display: inline-block;
      background: linear-gradient(145deg, #FF5722, #E64A19);
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 12px;
      margin: 2px;
    }
    .achievement {
      display: inline-block;
      background: linear-gradient(145deg, #FFD700, #FF9800);
      color: black;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      margin: 2px;
      font-weight: bold;
    }
    .progress-container {
      background: rgba(255,255,255,0.2);
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
      height: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #FFD700);
      transition: width 0.3s;
      width: 100%;
    }
  </style>
</head>
<body>

<!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
<div class="score-display">
  ğŸ† ã‚¹ã‚³ã‚¢: <span id="score">0</span>
</div>

<!-- ã‚³ãƒ³ãƒœè¡¨ç¤º -->
<div class="combo-display" id="comboDisplay">
  ğŸ”¥ ã‚³ãƒ³ãƒœ: <span id="comboCount">0</span>
</div>

<!-- SDGSè¡¨ç¤º -->
<div class="sdgs-display">
  <div class="sdgs-item" id="energy">âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼: <span>50%</span></div>
  <div class="sdgs-item" id="environment">ğŸŒ¿ ç’°å¢ƒ: <span>70%</span></div>
  <div class="sdgs-item" id="economy">ğŸ’° çµŒæ¸ˆ: <span>30%</span></div>
  <div class="sdgs-item" id="education">ğŸ“š æ•™è‚²: <span>60%</span></div>
</div>

<!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º -->
<div class="mission-display">
  <div style="font-weight: bold; margin-bottom: 8px;">ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
  <div id="missionTitle">ã‚¨ãƒãƒ«ã‚®ãƒ¼åŸºç›¤ã‚’ç¢ºç«‹</div>
  <div class="timer" id="gameTimer">â±ï¸ 05:00</div>
  <div class="progress-container">
    <div class="progress-bar" id="missionProgress" style="width: 100%"></div>
  </div>
  <div id="missionDescription" style="font-size: 12px; margin-top: 8px;">ç™ºé›»æ‰€ã‚’å»ºè¨­ã—ã¦é›»åŠ›ä¾›çµ¦ã‚’ç¢ºä¿ã›ã‚ˆï¼</div>
</div>

<!-- AIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
<div class="ai-dashboard">
  <div style="font-weight: bold; margin-bottom: 8px;">ğŸ¤– AIéƒ½å¸‚åˆ†æ</div>
  <div class="ai-metric" id="energyEff">âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡: è¨ˆç®—ä¸­...</div>
  <div class="ai-metric" id="envScore">ğŸŒ¿ ç’°å¢ƒã‚¹ã‚³ã‚¢: è¨ˆç®—ä¸­...</div>
  <div class="ai-metric" id="aiRecommendation">ğŸ’¡ AIææ¡ˆ: åˆ†æä¸­...</div>
  <button class="ui-button ai" id="aiOptimizeBtn" style="width: 100%; margin-top: 10px; font-size: 14px;">
    AIæœ€é©åŒ–ã‚’å®Ÿè¡Œ
  </button>
</div>

<!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
<div class="debug-info" id="debugInfo">
  ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...
</div>

<!-- å»ºç‰©é¸æŠãƒœã‚¿ãƒ³ -->
<div class="controls">
  <button class="ui-button" id="houseBtn">ğŸ  ä½å®…</button>
  <button class="ui-button hospital" id="hospitalBtn">ğŸ¥ ç—…é™¢</button>
  <button class="ui-button park" id="parkBtn">ğŸŒ³ å…¬åœ’</button>
  <button class="ui-button shop" id="shopBtn">ğŸª åº—èˆ—</button>
  <button class="ui-button power" id="powerBtn">âš¡ ç™ºé›»æ‰€</button>
</div>

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
<div class="message" id="message">
  <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ—ï¸ AIã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£ãƒ»ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h2>
  <p>æœªæ¥ã®è¡—ã‚’<strong>5åˆ†</strong>ã§ãƒ‡ã‚¶ã‚¤ãƒ³ï¼</p>
  <p>AIãŒæœ€é©ãªéƒ½å¸‚è¨ˆç”»ã‚’ã‚¢ãƒ‰ãƒã‚¤ã‚¹</p>
  <br>
  <p>ğŸ¤– AIæœ€é©åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ­è¼‰</p>
  <p>ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éƒ½å¸‚åˆ†æ</p>
  <p>ğŸ“ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªé€£æºæ©Ÿèƒ½</p>
  <br>
  <p>ğŸ“± Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’æ˜ ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
  <br>
  <button class="ui-button" id="startBtn" style="background:linear-gradient(145deg,#FFD700,#FF9800); font-size: 18px; padding: 15px 30px;">
    ğŸš€ ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼
  </button>
  <div style="margin-top: 15px;">
    <span class="tech-badge">A-Frame</span>
    <span class="tech-badge">AR.js</span>
    <span class="tech-badge">AIã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </span>
    <span class="tech-badge">SDGs</span>
    <span class="tech-badge">IoTã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
  </div>
</div>

<a-scene 
  embedded 
  arjs='sourceType: webcam; debugUIEnabled: false;'
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true;"
>

  <!-- ãƒãƒ¼ã‚«ãƒ¼ -->
  <a-marker preset="hiro" id="marker">
    <!-- åœ°é¢ -->
    <a-plane 
      position="0 0 0" 
      rotation="-90 0 0" 
      width="4" 
      height="4" 
      color="#7CFC00"
      opacity="0.3"
    ></a-plane>
    
    <!-- å»ºç‰©ã‚³ãƒ³ãƒ†ãƒŠ -->
    <a-entity id="buildings-container"></a-entity>
  </a-marker>
  
  <a-entity camera></a-entity>
</a-scene>

<script>
// ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
let score = 0;
let comboCount = 0;
let lastPlaceTime = 0;
let totalBuildings = 0;
let isMarkerVisible = false;
let gameTime = 300; // 5åˆ†
let gameTimer;
let gameStarted = false;
let currentMission = 0;
let achievements = [];

// SDGSçŠ¶æ…‹
let sdgsStatus = {
  energy: 50,
  environment: 70, 
  economy: 30,
  education: 60
};

// æ–½è¨­åŠ¹æœ
const buildingEffects = {
  house: { economy: 10, energy: -5, environment: -3 },
  hospital: { economy: 8, education: 15, energy: -8 },
  park: { environment: 20, energy: -3, economy: -2 },
  shop: { economy: 15, environment: -8, energy: -5 },
  power: { energy: 25, environment: -10, economy: 5 }
};

// ãƒŸãƒƒã‚·ãƒ§ãƒ³å®šç¾©
const missions = [
  {
    title: "âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼åŸºç›¤ã®ç¢ºç«‹",
    description: "ç™ºé›»æ‰€ã‚’å»ºè¨­ã—ã¦é›»åŠ›ä¾›çµ¦ã‚’ç¢ºä¿ã›ã‚ˆï¼",
    target: { energy: 70 }
  },
  {
    title: "ğŸŒ¿ ç’°å¢ƒãƒãƒ©ãƒ³ã‚¹ã®æ”¹å–„", 
    description: "ç’°å¢ƒã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Œï¼",
    target: { environment: 60, energy: 50 }
  },
  {
    title: "ğŸ—ï¸ ç·åˆã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£",
    description: "AIæœ€é©åŒ–ã§æŒç¶šå¯èƒ½ãªéƒ½å¸‚ã‚’å®Œæˆã•ã›ã‚ˆï¼",
    target: { economy: 60, education: 70, environment: 50 }
  }
];

// AIæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ 
class SmartCityAI {
  constructor() {
    this.algorithm = "éºä¼çš„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  + ç·šå½¢è¨ˆç”»æ³•";
    this.optimizationHistory = [];
  }
  
  analyzeCityStatus(sdgsStatus) {
    const energyEfficiency = this.calculateEnergyEfficiency(sdgsStatus);
    const environmentalScore = this.calculateEnvironmentalScore(sdgsStatus);
    
    const analysis = {
      energyEfficiency: Math.round(energyEfficiency),
      environmentalScore: Math.round(environmentalScore),
      overallEfficiency: Math.round((energyEfficiency + environmentalScore) / 2),
      recommendations: this.generateRecommendations(sdgsStatus)
    };
    
    this.optimizationHistory.push(analysis);
    return analysis;
  }
  
  calculateEnergyEfficiency(status) {
    return (status.energy * 0.6 + (100 - Math.abs(status.energy - status.environment)) * 0.4);
  }
  
  calculateEnvironmentalScore(status) {
    return (status.environment * 0.7 + (100 - Math.abs(status.environment - status.economy)) * 0.3);
  }
  
  generateRecommendations(status) {
    const recommendations = [];
    
    if (status.energy < 40) {
      recommendations.push("âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼å±æ©Ÿï¼ç™ºé›»æ‰€ã‚’ç·Šæ€¥å»ºè¨­ã›ã‚ˆ");
    }
    if (status.environment < 45) {
      recommendations.push("ğŸŒ¿ ç’°å¢ƒæ‚ªåŒ–ï¼å…¬åœ’ã§ç·‘åœ°ã‚’å¢—ã‚„ã›");
    }
    if (status.economy < 50) {
      recommendations.push("ğŸ’° çµŒæ¸ˆåœæ»ï¼å•†æ¥­æ–½è¨­ã§é›‡ç”¨å‰µå‡ºã‚’");
    }
    if (status.education < 55) {
      recommendations.push("ğŸ“š æ•™è‚²ä¸è¶³ï¼å­¦æ ¡ãƒ»ç—…é™¢ã§äººæè‚²æˆã‚’");
    }
    
    if (recommendations.length === 0) {
      recommendations.push("ğŸ‰ ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½ï¼ç¾åœ¨ã®é–‹ç™ºã‚’ç¶™ç¶šã›ã‚ˆ");
    }
    
    return recommendations;
  }
}

const cityAI = new SmartCityAI();

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame() {
  console.log('ğŸ® ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼');
  
  // ãƒãƒ¼ã‚«ãƒ¼ç¢ºèªã‚’ä¸€æ™‚çš„ã«å¤–ã—ã¦ãƒ†ã‚¹ãƒˆ
  // if (!isMarkerVisible) {
  //   showMessage('âŒ ã¾ãšã¯Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’æ˜ ã—ã¦ãã ã•ã„ï¼');
  //   return;
  // }
  
  document.getElementById('message').style.display = 'none';
  score = 0;
  comboCount = 0;
  totalBuildings = 0;
  gameTime = 300;
  gameStarted = true;
  currentMission = 0;
  achievements = [];
  
  // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
  sdgsStatus = { energy: 50, environment: 70, economy: 30, education: 60 };
  
  updateScore();
  updateSDGsDisplay();
  updateMissionDisplay();
  startGameTimer();
  updateComboDisplay();
  updateAIDashboard();
  
  console.log('âœ… ã‚²ãƒ¼ãƒ é–‹å§‹æˆåŠŸ');
}

function startGameTimer() {
  clearInterval(gameTimer);
  gameTimer = setInterval(() => {
    if (gameStarted) {
      gameTime--;
      updateTimerDisplay();
      
      // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
      const progress = (gameTime / 300) * 100;
      document.getElementById('missionProgress').style.width = progress + '%';
      
      if (gameTime <= 0) {
        endGame();
      }
      
      // 30ç§’ã”ã¨ã«AIåˆ†ææ›´æ–°
      if (gameTime % 30 === 0) {
        updateAIDashboard();
      }
      
      // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
      checkMissionCompletion();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(gameTime / 60);
  const seconds = gameTime % 60;
  const timerElement = document.getElementById('gameTimer');
  timerElement.textContent = `â±ï¸ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // æ®‹ã‚Š1åˆ†ã§è‰²ã‚’èµ¤ã
  if (gameTime <= 60) {
    timerElement.style.color = '#FF4444';
  }
}

function updateMissionDisplay() {
  const mission = missions[currentMission];
  document.getElementById('missionTitle').textContent = mission.title;
  document.getElementById('missionDescription').textContent = mission.description;
}

// å»ºç‰©ã‚’é…ç½®
function placeBuilding(type) {
  console.log('ğŸ—ï¸ å»ºç‰©å»ºè¨­:', type);
  
  if (!gameStarted) {
    showMessage('âŒ ã¾ãšã¯ã‚²ãƒ¼ãƒ ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ï¼');
    return;
  }
  
  const container = document.querySelector('#buildings-container');
  if (!container) return;

  // ã‚³ãƒ³ãƒœåˆ¤å®š
  const now = Date.now();
  let comboBonus = 0;
  if (now - lastPlaceTime < 2000) {
    comboCount++;
    comboBonus = Math.floor(comboCount / 3) * 5;
  } else {
    comboCount = 1;
  }
  lastPlaceTime = now;

  // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ä»˜ãï¼‰
  const baseScore = 10;
  const totalPoints = baseScore + comboBonus;
  score += totalPoints;
  totalBuildings++;
  
  // SDGsåŠ¹æœã‚’é©ç”¨
  if (buildingEffects[type]) {
    Object.keys(buildingEffects[type]).forEach(metric => {
      sdgsStatus[metric] += buildingEffects[type][metric];
      sdgsStatus[metric] = Math.max(0, Math.min(100, sdgsStatus[metric]));
    });
  }
  
  // å»ºç‰©ã‚’ä½œæˆ
  const building = document.createElement('a-entity');
  setupBuilding(building, type);
  container.appendChild(building);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  building.setAttribute('scale', '0.1 0.1 0.1');
  building.setAttribute('animation', {
    property: 'scale',
    to: '1 1 1',
    dur: 800,
    easing: 'easeOutElastic'
  });
  
  // ã‚³ãƒ³ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  if (comboBonus > 0) {
    showComboEffect();
    checkAchievement('combo');
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  showBuildMessage(`ğŸ—ï¸ ${getBuildingName(type)} å®Œæˆï¼`, totalPoints, comboBonus);
  
  updateScore();
  updateSDGsDisplay();
  updateComboDisplay();
  updateAIDashboard();
  checkAchievements();
  lastPlaceTime = now;
  
  // 15ç§’å¾Œã«å»ºç‰©ã‚’å‰Šé™¤
  setTimeout(() => {
    if (building.parentNode) {
      building.parentNode.removeChild(building);
    }
  }, 15000);
}

function setupBuilding(building, type) {
  // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®
  const x = (Math.random() - 0.5) * 2;
  const z = (Math.random() - 0.5) * 2;
  
  building.setAttribute('position', `${x} 0 ${z}`);
  
  switch(type) {
    case 'house':
      building.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.6; depth: 0.6');
      building.setAttribute('material', 'color: #2196F3; metalness: 0.3; roughness: 0.4');
      break;
      
    case 'hospital':
      building.setAttribute('geometry', 'primitive: box; width: 0.7; height: 0.9; depth: 0.7');
      building.setAttribute('material', 'color: white; metalness: 0.2; roughness: 0.3');
      break;
      
    case 'park':
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.6; height: 0.1');
      building.setAttribute('material', 'color: #4CAF50');
      break;
      
    case 'shop':
      building.setAttribute('geometry', 'primitive: box; width: 0.7; height: 0.5; depth: 0.7');
      building.setAttribute('material', 'color: #FF5722; metalness: 0.4; roughness: 0.2');
      break;
      
    case 'power':
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.4; height: 1.0');
      building.setAttribute('material', 'color: #FFD700; metalness: 0.7; roughness: 0.2');
      break;
  }
}

function showComboEffect() {
  const comboDisplay = document.getElementById('comboDisplay');
  document.getElementById('comboCount').textContent = comboCount;
  comboDisplay.style.display = 'block';
  
  setTimeout(() => {
    comboDisplay.style.display = 'none';
  }, 2000);
}

function updateAIDashboard() {
  const analysis = cityAI.analyzeCityStatus(sdgsStatus);
  
  document.getElementById('energyEff').textContent = `âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡: ${analysis.energyEfficiency}%`;
  document.getElementById('envScore').textContent = `ğŸŒ¿ ç’°å¢ƒã‚¹ã‚³ã‚¢: ${analysis.environmentalScore}%`;
  document.getElementById('aiRecommendation').textContent = `ğŸ’¡ AIææ¡ˆ: ${analysis.recommendations[0]}`;
}

function executeAIOptimization() {
  if (!gameStarted) return;
  
  const analysis = cityAI.analyzeCityStatus(sdgsStatus);
  const recommendation = analysis.recommendations[0];
  
  let buildingType = 'house';
  if (recommendation.includes('ç™ºé›»æ‰€')) buildingType = 'power';
  else if (recommendation.includes('å…¬åœ’')) buildingType = 'park';
  else if (recommendation.includes('å•†æ¥­æ–½è¨­')) buildingType = 'shop';
  else if (recommendation.includes('å­¦æ ¡') || recommendation.includes('ç—…é™¢')) buildingType = 'hospital';
  
  showBuildMessage(`ğŸ¤– AIæœ€é©åŒ–: ${getBuildingName(buildingType)}ã‚’æ¨å¥¨`, 0, 0);
  placeBuilding(buildingType);
  checkAchievement('ai');
}

function checkMissionCompletion() {
  const mission = missions[currentMission];
  let completed = true;
  
  Object.keys(mission.target).forEach(target => {
    if (sdgsStatus[target] < mission.target[target]) {
      completed = false;
    }
  });
  
  if (completed && currentMission < missions.length - 1) {
    const bonus = 150;
    score += bonus;
    showBuildMessage(`ğŸ‰ ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ï¼ +${bonus}ãƒœãƒ¼ãƒŠã‚¹`, bonus, 0);
    currentMission++;
    updateMissionDisplay();
    checkAchievement('mission');
  }
}

function checkAchievements() {
  if (score >= 500 && !achievements.includes('high_score')) {
    achievements.push('high_score');
    showBuildMessage('ğŸ† å®Ÿç¸¾: ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚¹ã‚¿ãƒ¼', 0, 0);
  }
  
  if (totalBuildings >= 15 && !achievements.includes('builder')) {
    achievements.push('builder');
    showBuildMessage('ğŸ—ï¸ å®Ÿç¸¾: å»ºè¨­ãƒã‚¹ã‚¿ãƒ¼', 0, 0);
  }
}

function checkAchievement(type) {
  if (type === 'combo' && comboCount >= 5 && !achievements.includes('combo')) {
    achievements.push('combo');
    showBuildMessage('ğŸ”¥ å®Ÿç¸¾: ã‚³ãƒ³ãƒœãƒã‚¹ã‚¿ãƒ¼', 0, 0);
  }
  
  if (type === 'ai' && !achievements.includes('ai_user')) {
    achievements.push('ai_user');
    showBuildMessage('ğŸ¤– å®Ÿç¸¾: AIãƒ‘ã‚¤ã‚ªãƒ‹ã‚¢', 0, 0);
  }
  
  if (type === 'mission' && currentMission === missions.length - 1 && !achievements.includes('mission_complete')) {
    achievements.push('mission_complete');
    showBuildMessage('ğŸ¯ å®Ÿç¸¾: ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ', 0, 0);
  }
}

function updateSDGsDisplay() {
  Object.keys(sdgsStatus).forEach(metric => {
    const element = document.getElementById(metric);
    if (element) {
      const value = sdgsStatus[metric];
      const span = element.querySelector('span');
      if (span) {
        span.textContent = value + '%';
      }
      element.style.color = value > 70 ? '#4CAF50' : value > 30 ? '#FF9800' : '#F44336';
    }
  });
}

function updateComboDisplay() {
  // ã‚³ãƒ³ãƒœè¡¨ç¤ºã¯showComboEffectã§å‡¦ç†
}

function updateScore() {
  document.getElementById('score').textContent = score;
}

function showBuildMessage(text, points, comboBonus) {
  const messageDiv = document.getElementById('message');
  let bonusText = '';
  
  if (comboBonus > 0) {
    bonusText = `<br>ğŸ”¥ ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ +${comboBonus}ç‚¹ï¼`;
  }
  
  // å®Ÿç¸¾è¡¨ç¤º
  let achievementText = '';
  if (text.includes('å®Ÿç¸¾:')) {
    achievementText = `<div style="margin: 10px 0;"><span class="achievement">${text}</span></div>`;
    text = '';
  }
  
  messageDiv.innerHTML = `
    <h3 style="color: #FFD700;">${text}</h3>
    ${points > 0 ? `<p style="font-size: 20px; margin: 10px 0; color: #4CAF50;">+${points} ç‚¹ç²å¾—ï¼${bonusText}</p>` : ''}
    ${achievementText}
    <button class="ui-button" onclick="hideMessage()" style="margin-top: 15px; background: linear-gradient(145deg, #FF5722, #E64A19);">OK</button>
  `;
  messageDiv.style.display = 'block';
  
  setTimeout(() => {
    if (messageDiv.style.display !== 'none') {
      messageDiv.style.display = 'none';
    }
  }, 3000);
}

function showMessage(text) {
  const messageDiv = document.getElementById('message');
  messageDiv.innerHTML = `
    <h3>${text}</h3>
    <button class="ui-button" onclick="hideMessage()" style="margin-top: 15px;">OK</button>
  `;
  messageDiv.style.display = 'block';
}

function hideMessage() {
  document.getElementById('message').style.display = 'none';
}

function endGame() {
  gameStarted = false;
  clearInterval(gameTimer);
  
  const totalScore = score;
  const avgSDGs = (sdgsStatus.energy + sdgsStatus.environment + sdgsStatus.economy + sdgsStatus.education) / 4;
  
  // æŠ€è¡“ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  const techReport = `
    <strong>å®Ÿè£…æŠ€è¡“:</strong><br>
    â€¢ A-Frame + AR.js + Three.js<br>
    â€¢ AIæœ€é©åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ <br>
    â€¢ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SDGsæŒ‡æ¨™ç®¡ç†<br>
    â€¢ WebGL 3Dãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°<br><br>
    <strong>å¯¾å¿œSDGsç›®æ¨™:</strong><br>
    â€¢ 7. ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ã¿ã‚“ãªã«<br>
    â€¢ 11. ä½ã¿ç¶šã‘ã‚‰ã‚Œã‚‹ã¾ã¡ã¥ãã‚Š<br>
    â€¢ 13. æ°—å€™å¤‰å‹•ã«å…·ä½“çš„ãªå¯¾ç­–ã‚’
  `;
  
  // å®Ÿç¸¾è¡¨ç¤º
  let achievementsHTML = '';
  if (achievements.length > 0) {
    achievementsHTML = `<div style="margin: 10px 0;">
      <strong>ç²å¾—å®Ÿç¸¾:</strong><br>
      ${achievements.map(a => `<span class="achievement">${a}</span>`).join(' ')}
    </div>`;
  }
  
  document.getElementById('message').innerHTML = `
    <div style="text-align: center;">
      <h2 style="color: #FFD700; margin-bottom: 20px;">ğŸŠ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸŠ</h2>
      
      <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin: 15px 0;">
        <h3>ğŸ† æœ€çµ‚ã‚¹ã‚³ã‚¢: ${totalScore}ç‚¹</h3>
        <p>SDGsãƒãƒ©ãƒ³ã‚¹: ${Math.round(avgSDGs)}%</p>
        <p>å»ºè¨­æ–½è¨­æ•°: ${totalBuildings}å€‹</p>
        <p>æœ€å¤§ã‚³ãƒ³ãƒœ: ${comboCount}å›</p>
        <p>é”æˆãƒŸãƒƒã‚·ãƒ§ãƒ³: ${currentMission + 1}/${missions.length}</p>
      </div>
      
      ${achievementsHTML}
      
      <div style="background: rgba(0,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0; text-align: left;">
        <h4>ğŸ¤– æŠ€è¡“å®Ÿè£…ãƒ¬ãƒãƒ¼ãƒˆ</h4>
        <div style="font-size: 14px;">${techReport}</div>
      </div>
      
      <p style="margin: 10px 0;">ğŸ“¸ ã“ã®ç”»é¢ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼</p>
      <p style="margin-bottom: 20px;">ğŸ“ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«æ´»ç”¨ã—ã‚ˆã†ï¼</p>
      
      <button class="ui-button" onclick="restartGame()" style="background:linear-gradient(145deg,#2196F3,#1976D2); margin: 5px;">
        ã‚‚ã†ä¸€åº¦éŠã¶
      </button>
    </div>
  `;
  document.getElementById('message').style.display = 'block';
}

function restartGame() {
  document.getElementById('message').style.display = 'none';
  const container = document.querySelector('#buildings-container');
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  startGame();
}

function getBuildingName(type) {
  const names = {
    house: 'ä½å®…',
    hospital: 'ç—…é™¢', 
    park: 'å…¬åœ’',
    shop: 'åº—èˆ—',
    power: 'ç™ºé›»æ‰€'
  };
  return names[type] || 'å»ºç‰©';
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
function initializeGame() {
  console.log('ğŸ”„ ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');
  
  // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
  document.getElementById('startBtn').addEventListener('click', startGame);
  
  // æ–½è¨­ãƒœã‚¿ãƒ³
  const buttonConfig = {
    'houseBtn': 'house',
    'hospitalBtn': 'hospital',
    'parkBtn': 'park', 
    'shopBtn': 'shop',
    'powerBtn': 'power'
  };
  
  Object.keys(buttonConfig).forEach(btnId => {
    document.getElementById(btnId).addEventListener('click', () => placeBuilding(buttonConfig[btnId]));
  });
  
  // AIæœ€é©åŒ–ãƒœã‚¿ãƒ³
  document.getElementById('aiOptimizeBtn').addEventListener('click', executeAIOptimization);
  
  // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆ
  const marker = document.querySelector('#marker');
  if (marker) {
    marker.addEventListener('markerFound', () => {
      console.log('âœ… ãƒãƒ¼ã‚«ãƒ¼èªè­˜æˆåŠŸï¼');
      isMarkerVisible = true;
      document.getElementById('debugInfo').textContent = 'âœ… ãƒãƒ¼ã‚«ãƒ¼èªè­˜ä¸­';
      document.getElementById('debugInfo').style.background = 'rgba(0,255,0,0.8)';
    });
    
    marker.addEventListener('markerLost', () => {
      console.log('âŒ ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±');
      isMarkerVisible = false;
      document.getElementById('debugInfo').textContent = 'âŒ ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...';
      document.getElementById('debugInfo').style.background = 'rgba(255,0,0,0.8)';
    });
  }
  
  // ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒå¯¾å¿œ
  const buttons = document.querySelectorAll('.ui-button');
  buttons.forEach(button => {
    button.addEventListener('touchstart', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(0.95)';
    });
    
    button.addEventListener('touchend', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(1)';
    });
  });
  
  console.log('âœ… ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', initializeGame);

// ã‚¹ãƒãƒ›ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾ç­–
document.addEventListener('touchmove', function(e) {
  e.preventDefault();
}, { passive: false });
</script>

</body>
</html>
