<!DOCTYPE html>
<html>
<head>
  <title>AR街づくりゲーム - 改良版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- 安定版のAR.js -->
  <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      background: #000;
      touch-action: none;
    }
    .ui-button {
      padding: 15px 20px;
      margin: 8px;
      font-size: 18px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(145deg, #4CAF50, #45a049);
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      min-width: 140px;
      touch-action: manipulation;
      user-select: none;
      transition: all 0.2s;
    }
    .ui-button:active {
      transform: scale(0.92);
      background: linear-gradient(145deg, #45a049, #4CAF50);
    }
    .ui-button.house {
      background: linear-gradient(145deg, #2196F3, #1976D2);
    }
    .ui-button.hospital {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    .score-display {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 28px;
      color: white;
      z-index: 100;
      background: rgba(0,0,0,0.8);
      padding: 15px 25px;
      border-radius: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      border: 2px solid #fff;
    }
    .controls {
      position: fixed;
      bottom: 30px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 100;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 0 10px;
    }
    .message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      background: rgba(0,0,0,0.9);
      padding: 30px;
      border-radius: 20px;
      z-index: 200;
      border: 3px solid #fff;
      max-width: 90%;
    }
    .building-info {
      position: fixed;
      top: 100px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 90;
    }
    .debug-info {
      position: fixed;
      bottom: 120px;
      left: 20px;
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 90;
    }
  </style>
</head>
<body>

<!-- スコア表示 -->
<div class="score-display">
  🏆 スコア: <span id="score">0</span>
</div>

<!-- 建物情報 -->
<div class="building-info" id="buildingInfo">
  🏠 住宅: +5点<br>
  🏥 病院: +10点<br>
  🌳 公園: +3点<br>
  🏪 店舗: +7点<br>
  ⭐ コンボボーナスあり！
</div>

<!-- デバッグ情報 -->
<div class="debug-info" id="debugInfo">
  マーカーを探しています...
</div>

<!-- 建物選択ボタン -->
<div class="controls">
  <button class="ui-button house" onclick="placeBuilding('house')">🏠 住宅 (+5)</button>
  <button class="ui-button hospital" onclick="placeBuilding('hospital')">🏥 病院 (+10)</button>
  <button class="ui-button" onclick="placeBuilding('park')" style="background:linear-gradient(145deg,#9C27B0,#7B1FA2)">🌳 公園 (+3)</button>
  <button class="ui-button" onclick="placeBuilding('shop')" style="background:linear-gradient(145deg,#FF5722,#E64A19)">🏪 店舗 (+7)</button>
</div>

<!-- メッセージ表示 -->
<div class="message" id="message">
  <h2>🎮 AR街づくりゲーム 🎮</h2>
  <p>1. Hiroマーカーをカメラに映してください</p>
  <p>2. 下のボタンで建物を建設！</p>
  <p>3. 連続建設でコンボボーナス！</p>
  <br>
  <button class="ui-button" onclick="startGame()" style="padding: 12px 30px;">ゲームスタート！</button>
</div>

<a-scene 
  embedded 
  arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; precision: high;"
  light="defaultLightsEnabled: true;"
>

  <!-- ライティング -->
  <a-entity light="type: ambient; color: #888; intensity: 0.9"></a-entity>
  <a-entity light="type: directional; color: #FFF; intensity: 1.0; position: 2 5 3"></a-entity>

  <!-- マーカー -->
  <a-marker preset="hiro" emitevents="true" id="marker" smooth="true" smoothCount="10" smoothTolerance="0.01">
    <!-- 地面 -->
    <a-plane 
      position="0 0 0" 
      rotation="-90 0 0" 
      width="4" 
      height="4" 
      color="#7CFC00"
      opacity="0.3"
    ></a-plane>
    
    <!-- 建物コンテナ - マーカーの中心に配置 -->
    <a-entity id="buildings-container" position="0 0.1 0"></a-entity>
  </a-marker>
  
  <a-entity camera position="0 1.6 0" look-controls-enabled="false"></a-entity>
</a-scene>

<script>
let score = 0;
let comboCount = 0;
let lastPlaceTime = 0;
let totalBuildings = 0;
let isMarkerVisible = false;
const buildingPrices = {
  house: 5,
  hospital: 10,
  park: 3,
  shop: 7
};

// ゲーム開始
function startGame() {
  document.getElementById('message').style.display = 'none';
  score = 0;
  comboCount = 0;
  totalBuildings = 0;
  updateScore();
}

// スマホタッチ対応
function setupTouchEvents() {
  const buttons = document.querySelectorAll('.ui-button');
  buttons.forEach(button => {
    button.addEventListener('touchstart', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(0.92)';
    }, { passive: false });
    
    button.addEventListener('touchend', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(1)';
      // タップしたボタンの機能を実行
      const type = this.getAttribute('onclick').match(/'([^']+)'/)[1];
      if (isMarkerVisible) {
        placeBuilding(type);
      } else {
        showMessage('❌ マーカーを映してください！', 0, 0);
      }
    }, { passive: false });
  });
}

// 建物を配置
function placeBuilding(type) {
  if (!isMarkerVisible) {
    showMessage('❌ まずはマーカーを映してください！', 0, 0);
    return;
  }
  
  const container = document.querySelector('#buildings-container');
  if (!container) return;
  
  const baseScore = buildingPrices[type] || 5;
  
  // コンボ判定（3秒以内ならコンボ継続）
  const now = Date.now();
  if (now - lastPlaceTime < 3000) {
    comboCount++;
  } else {
    comboCount = 1;
  }
  
  // コンボボーナス計算
  let comboBonus = 0;
  if (comboCount >= 3) {
    comboBonus = Math.floor(comboCount / 3) * 5;
  }
  
  const totalPoints = baseScore + comboBonus;
  
  // スコア加算
  score += totalPoints;
  totalBuildings++;
  
  // 建物を作成
  const buildingId = 'building-' + Date.now();
  const building = document.createElement('a-entity');
  building.setAttribute('id', buildingId);
  
  // 建物の種類に応じた設定
  setupBuilding(building, type, totalBuildings);
  
  container.appendChild(building);
  
  // アニメーション
  building.setAttribute('scale', '0.1 0.1 0.1');
  building.setAttribute('animation', {
    property: 'scale',
    to: '1 1 1',
    dur: 800,
    easing: 'easeOutElastic'
  });
  
  // メッセージ表示
  showMessage(`🏗️ ${getBuildingName(type)} 完成！`, totalPoints, comboBonus);
  
  updateScore();
  lastPlaceTime = now;
  
  // 15秒後に建物を削除（パフォーマンス対策）
  setTimeout(() => {
    if (building.parentNode) {
      building.parentNode.removeChild(building);
    }
  }, 15000);
}

// 建物の設定 - 上から見てもわかりやすい形に
function setupBuilding(building, type, index) {
  // グリッド状に配置（マーカーの中心から放射状に）
  const angle = (index * 137.5) % 360; // 黄金角で配置
  const radius = 1.2 + Math.floor((index - 1) / 8) * 0.8;
  const x = Math.cos(angle * Math.PI / 180) * radius;
  const z = Math.sin(angle * Math.PI / 180) * radius;
  
  building.setAttribute('position', `${x} 0 ${z}`);
  
  // 建物を常にカメラ方向に向ける
  building.setAttribute('look-at', '[camera]');
  
  switch(type) {
    case 'house':
      // 住宅 - 三角屋根の家（上から見ても識別可能）
      building.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.6; depth: 0.6');
      building.setAttribute('material', 'color: #2196F3; metalness: 0.3; roughness: 0.4');
      
      const roof = document.createElement('a-entity');
      roof.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.5; radiusTop: 0; height: 0.5');
      roof.setAttribute('material', 'color: #1976D2');
      roof.setAttribute('position', '0 0.55 0');
      building.appendChild(roof);
      
      // 煙突
      const chimney = document.createElement('a-entity');
      chimney.setAttribute('geometry', 'primitive: box; width: 0.1; height: 0.3; depth: 0.1');
      chimney.setAttribute('material', 'color: #795548');
      chimney.setAttribute('position', '0.2 0.75 0.2');
      building.appendChild(chimney);
      break;
      
    case 'hospital':
      // 病院 - 十字マークが目印
      building.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.8; depth: 0.8');
      building.setAttribute('material', 'color: white; metalness: 0.2; roughness: 0.3');
      
      const redCross = document.createElement('a-entity');
      redCross.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.1; depth: 0.05');
      redCross.setAttribute('material', 'color: red');
      redCross.setAttribute('position', '0 0 0.41');
      building.appendChild(redCross);
      
      const redCross2 = document.createElement('a-entity');
      redCross2.setAttribute('geometry', 'primitive: box; width: 0.1; height: 0.6; depth: 0.05');
      redCross2.setAttribute('material', 'color: red');
      redCross2.setAttribute('position', '0 0 0.41');
      building.appendChild(redCross2);
      break;
      
    case 'park':
      // 公園 - 緑の広場と木
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.7; height: 0.05');
      building.setAttribute('material', 'color: #4CAF50');
      
      const tree1 = document.createElement('a-entity');
      tree1.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.15; radiusTop: 0; height: 0.6');
      tree1.setAttribute('material', 'color: #2E7D32');
      tree1.setAttribute('position', '0.3 0.3 0.3');
      building.appendChild(tree1);
      
      const tree2 = document.createElement('a-entity');
      tree2.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.15; radiusTop: 0; height: 0.6');
      tree2.setAttribute('material', 'color: #2E7D32');
      tree2.setAttribute('position', '-0.3 0.3 -0.3');
      building.appendChild(tree2);
      break;
      
    case 'shop':
      // 店舗 - 看板付き
      building.setAttribute('geometry', 'primitive: box; width: 0.7; height: 0.5; depth: 0.7');
      building.setAttribute('material', 'color: #FF5722; metalness: 0.4; roughness: 0.2');
      
      const sign = document.createElement('a-entity');
      sign.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.2; depth: 0.02');
      sign.setAttribute('material', 'color: #FFC107');
      sign.setAttribute('position', '0 0.6 0.36');
      sign.setAttribute('look-at', '[camera]');
      building.appendChild(sign);
      
      // 看板の文字（簡易表現）
      const signText = document.createElement('a-entity');
      signText.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.05; depth: 0.01');
      signText.setAttribute('material', 'color: #FF5722');
      signText.setAttribute('position', '0 0.6 0.38');
      building.appendChild(signText);
      break;
  }
  
  // 影を追加（立体感向上）
  const shadow = document.createElement('a-entity');
  shadow.setAttribute('geometry', 'primitive: circle; radius: 0.4');
  shadow.setAttribute('material', 'color: #000; opacity: 0.3; shader: flat');
  shadow.setAttribute('rotation', '-90 0 0');
  shadow.setAttribute('position', '0 0.01 0');
  building.appendChild(shadow);
}

// メッセージ表示
function showMessage(text, points, comboBonus) {
  const messageDiv = document.getElementById('message');
  let bonusText = '';
  
  if (comboBonus > 0) {
    bonusText = `<br>⭐ コンボボーナス +${comboBonus}点！`;
  }
  
  messageDiv.innerHTML = `
    <h3>${text}</h3>
    <p style="font-size: 24px; margin: 10px 0;">+${points} 点獲得！${bonusText}</p>
    <p>コンボ: ${comboCount}回連続</p>
    <button class="ui-button" onclick="this.parentElement.style.display='none'" style="margin-top: 15px;">OK</button>
  `;
  messageDiv.style.display = 'block';
  
  // 3秒後に自動非表示
  setTimeout(() => {
    if (messageDiv.style.display !== 'none') {
      messageDiv.style.display = 'none';
    }
  }, 3000);
}

function getBuildingName(type) {
  const names = {
    house: '住宅',
    hospital: '病院',
    park: '公園',
    shop: '店舗'
  };
  return names[type] || '建物';
}

function updateScore() {
  document.getElementById('score').textContent = score;
  
  // レベル表示
  const level = Math.floor(score / 50) + 1;
  document.querySelector('.score-display').innerHTML = 
    `🏆 Lv.${level | 0} スコア: <span id="score">${score}</span>`;
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
  setupTouchEvents();
  
  // マーカー検出時の処理
  const marker = document.querySelector('#marker');
  if (marker) {
    marker.addEventListener('markerFound', () => {
      console.log('🎯 マーカー認識！');
      isMarkerVisible = true;
      document.getElementById('debugInfo').textContent = '✅ マーカー認識中';
      document.getElementById('debugInfo').style.background = 'rgba(0,255,0,0.8)';
    });
    
    marker.addEventListener('markerLost', () => {
      console.log('❌ マーカー消失');
      isMarkerVisible = false;
      document.getElementById('debugInfo').textContent = '❌ マーカーを探しています...';
      document.getElementById('debugInfo').style.background = 'rgba(255,0,0,0.8)';
    });
  }
});

// スマホのタッチイベント対策
document.addEventListener('touchmove', function(e) {
  e.preventDefault();
}, { passive: false });

</script>

</body>
</html>
