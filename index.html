<!DOCTYPE html>
<html>
<head>
  <title>ã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£å»ºè¨­ã‚²ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- å®‰å®šç‰ˆAR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      background: #000;
      touch-action: none;
    }
    .ui-button {
      padding: 15px 20px;
      margin: 8px;
      font-size: 16px;
      border: none;
      border-radius: 15px;
      background: linear-gradient(145deg, #2196F3, #1976D2);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      touch-action: manipulation;
      user-select: none;
      transition: all 0.2s;
    }
    .ui-button:active {
      transform: scale(0.95);
    }
    .ui-button.hospital {
      background: linear-gradient(145deg, #4CAF50, #45a049);
    }
    .ui-button.park {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    .ui-button.shop {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    .ui-button.power {
      background: linear-gradient(145deg, #FFD700, #FFC107);
    }
    .score-display {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 24px;
      color: white;
      z-index: 100;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #fff;
    }
    .controls {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 100;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 0 10px;
    }
    .message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      background: rgba(0,0,0,0.9);
      padding: 25px;
      border-radius: 15px;
      z-index: 200;
      border: 2px solid #FFD700;
      max-width: 90%;
    }
    .sdgs-display {
      position: fixed;
      top: 100px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 10px;
      color: white;
      z-index: 90;
      border: 2px solid #4CAF50;
    }
    .sdgs-item {
      margin: 5px 0;
      font-size: 14px;
    }
    .mission-display {
      position: fixed;
      top: 250px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #FF9800;
      z-index: 90;
      max-width: 250px;
    }
    .timer {
      font-size: 20px;
      font-weight: bold;
      color: #FFD700;
      text-align: center;
      margin: 8px 0;
    }
    .debug-info {
      position: fixed;
      bottom: 120px;
      left: 20px;
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 90;
    }
  </style>
</head>
<body>

<!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
<div class="score-display">
  ğŸ† ã‚¹ã‚³ã‚¢: <span id="score">0</span>
</div>

<!-- SDGSè¡¨ç¤º -->
<div class="sdgs-display">
  <div class="sdgs-item" id="energy">âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼: <span>50%</span></div>
  <div class="sdgs-item" id="environment">ğŸŒ¿ ç’°å¢ƒ: <span>70%</span></div>
  <div class="sdgs-item" id="economy">ğŸ’° çµŒæ¸ˆ: <span>30%</span></div>
</div>

<!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º -->
<div class="mission-display">
  <div>ğŸ¯ <span id="missionTitle">ã‚¨ãƒãƒ«ã‚®ãƒ¼åŸºç›¤ã‚’ç¢ºç«‹</span></div>
  <div class="timer" id="gameTimer">â±ï¸ 03:00</div>
</div>

<!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
<div class="debug-info" id="debugInfo">
  ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...
</div>

<!-- å»ºç‰©é¸æŠãƒœã‚¿ãƒ³ -->
<div class="controls">
  <button class="ui-button" onclick="placeBuilding('house')">ğŸ  ä½å®…</button>
  <button class="ui-button hospital" onclick="placeBuilding('hospital')">ğŸ¥ ç—…é™¢</button>
  <button class="ui-button park" onclick="placeBuilding('park')">ğŸŒ³ å…¬åœ’</button>
  <button class="ui-button shop" onclick="placeBuilding('shop')">ğŸª åº—èˆ—</button>
  <button class="ui-button power" onclick="placeBuilding('power')">âš¡ ç™ºé›»æ‰€</button>
</div>

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
<div class="message" id="message">
  <h2>ğŸ—ï¸ ã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£å»ºè¨­</h2>
  <p>Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’æ˜ ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
  <br>
  <button class="ui-button" onclick="startGame()" style="background:linear-gradient(145deg,#FFD700,#FF9800)">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<a-scene 
  embedded 
  arjs='sourceType: webcam; debugUIEnabled: false;'
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true;"
>

  <!-- ãƒãƒ¼ã‚«ãƒ¼ -->
  <a-marker preset="hiro" id="marker">
    <!-- åœ°é¢ -->
    <a-plane 
      position="0 0 0" 
      rotation="-90 0 0" 
      width="3" 
      height="3" 
      color="#7CFC00"
      opacity="0.2"
    ></a-plane>
    
    <!-- å»ºç‰©ã‚³ãƒ³ãƒ†ãƒŠ -->
    <a-entity id="buildings-container"></a-entity>
  </a-marker>
  
  <a-entity camera></a-entity>
</a-scene>

<script>
// ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let score = 0;
let gameTime = 180;
let gameTimer;
let gameStarted = false;
let isMarkerVisible = false;

// SDGSçŠ¶æ…‹
let sdgsStatus = {
  energy: 50,
  environment: 70, 
  economy: 30
};

// æ–½è¨­åŠ¹æœ
const buildingEffects = {
  house: { economy: 8, energy: -3 },
  hospital: { economy: 5, energy: -5 },
  park: { environment: 15, energy: -2 },
  shop: { economy: 12, environment: -5 },
  power: { energy: 20, environment: -8 }
};

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame() {
  if (!isMarkerVisible) {
    showMessage('âŒ ã¾ãšã¯Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’æ˜ ã—ã¦ãã ã•ã„ï¼');
    return;
  }
  
  document.getElementById('message').style.display = 'none';
  score = 0;
  gameTime = 180;
  gameStarted = true;
  
  // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
  sdgsStatus = { energy: 50, environment: 70, economy: 30 };
  
  updateScore();
  updateSDGsDisplay();
  startGameTimer();
}

function startGameTimer() {
  clearInterval(gameTimer);
  gameTimer = setInterval(() => {
    if (gameStarted) {
      gameTime--;
      updateTimerDisplay();
      
      if (gameTime <= 0) {
        endGame();
      }
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(gameTime / 60);
  const seconds = gameTime % 60;
  document.getElementById('gameTimer').textContent = 
    `â±ï¸ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// å»ºç‰©ã‚’é…ç½®
function placeBuilding(type) {
  if (!gameStarted || !isMarkerVisible) {
    showMessage('âŒ ã‚²ãƒ¼ãƒ ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ï¼');
    return;
  }
  
  const container = document.querySelector('#buildings-container');
  if (!container) return;

  // ã‚¹ã‚³ã‚¢åŠ ç®—
  score += 10;
  
  // SDGsåŠ¹æœã‚’é©ç”¨
  if (buildingEffects[type]) {
    Object.keys(buildingEffects[type]).forEach(metric => {
      sdgsStatus[metric] += buildingEffects[type][metric];
      sdgsStatus[metric] = Math.max(0, Math.min(100, sdgsStatus[metric]));
    });
  }
  
  // å»ºç‰©ã‚’ä½œæˆ
  const building = document.createElement('a-entity');
  setupBuilding(building, type);
  container.appendChild(building);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  building.setAttribute('scale', '0.1 0.1 0.1');
  building.setAttribute('animation', {
    property: 'scale',
    to: '1 1 1',
    dur: 600,
    easing: 'easeOutElastic'
  });
  
  updateScore();
  updateSDGsDisplay();
  
  // 10ç§’å¾Œã«å»ºç‰©ã‚’å‰Šé™¤
  setTimeout(() => {
    if (building.parentNode) {
      building.parentNode.removeChild(building);
    }
  }, 10000);
}

function setupBuilding(building, type) {
  // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®
  const x = (Math.random() - 0.5) * 2;
  const z = (Math.random() - 0.5) * 2;
  
  building.setAttribute('position', `${x} 0 ${z}`);
  
  switch(type) {
    case 'house':
      building.setAttribute('geometry', 'primitive: box; width: 0.5; height: 0.5; depth: 0.5');
      building.setAttribute('material', 'color: #2196F3');
      break;
      
    case 'hospital':
      building.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.8; depth: 0.6');
      building.setAttribute('material', 'color: white');
      break;
      
    case 'park':
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.4; height: 0.1');
      building.setAttribute('material', 'color: #4CAF50');
      break;
      
    case 'shop':
      building.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.4; depth: 0.6');
      building.setAttribute('material', 'color: #FF5722');
      break;
      
    case 'power':
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.3; height: 0.8');
      building.setAttribute('material', 'color: #FFD700');
      break;
  }
}

function updateSDGsDisplay() {
  Object.keys(sdgsStatus).forEach(metric => {
    const element = document.getElementById(metric);
    if (element) {
      const value = sdgsStatus[metric];
      const span = element.querySelector('span');
      if (span) {
        span.textContent = value + '%';
      }
      element.style.color = value > 70 ? '#4CAF50' : value > 30 ? '#FF9800' : '#F44336';
    }
  });
}

function updateScore() {
  document.getElementById('score').textContent = score;
}

function showMessage(text) {
  const messageDiv = document.getElementById('message');
  messageDiv.innerHTML = `
    <h3>${text}</h3>
    <button class="ui-button" onclick="this.parentElement.style.display='none'" style="margin-top: 15px;">OK</button>
  `;
  messageDiv.style.display = 'block';
}

function endGame() {
  gameStarted = false;
  clearInterval(gameTimer);
  
  const totalScore = score;
  const avgSDGs = (sdgsStatus.energy + sdgsStatus.environment + sdgsStatus.economy) / 3;
  
  document.getElementById('message').innerHTML = `
    <h2>ğŸŠ ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
    <p>æœ€çµ‚ã‚¹ã‚³ã‚¢: ${totalScore}ç‚¹</p>
    <p>SDGsãƒãƒ©ãƒ³ã‚¹: ${Math.round(avgSDGs)}%</p>
    <br>
    <button class="ui-button" onclick="restartGame()" style="background:linear-gradient(145deg,#2196F3,#1976D2)">
      ã‚‚ã†ä¸€åº¦éŠã¶
    </button>
  `;
  document.getElementById('message').style.display = 'block';
}

function restartGame() {
  document.getElementById('message').style.display = 'none';
  const container = document.querySelector('#buildings-container');
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  startGame();
}

// ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆ
const marker = document.querySelector('#marker');
if (marker) {
  marker.addEventListener('markerFound', () => {
    console.log('âœ… ãƒãƒ¼ã‚«ãƒ¼èªè­˜æˆåŠŸï¼');
    isMarkerVisible = true;
    document.getElementById('debugInfo').textContent = 'âœ… ãƒãƒ¼ã‚«ãƒ¼èªè­˜ä¸­';
    document.getElementById('debugInfo').style.background = 'rgba(0,255,0,0.8)';
  });
  
  marker.addEventListener('markerLost', () => {
    console.log('âŒ ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±');
    isMarkerVisible = false;
    document.getElementById('debugInfo').textContent = 'âŒ ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...';
    document.getElementById('debugInfo').style.background = 'rgba(255,0,0,0.8)';
  });
}

// ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒå¯¾å¿œ
document.addEventListener('touchstart', function(e) {
  if (e.target.classList.contains('ui-button')) {
    e.target.style.transform = 'scale(0.95)';
  }
});

document.addEventListener('touchend', function(e) {
  if (e.target.classList.contains('ui-button')) {
    e.target.style.transform = 'scale(1)';
  }
});
</script>

</body>
</html>
