<!DOCTYPE html>
<html>
<head>
  <title>ARè¡—ã¥ãã‚Šã‚²ãƒ¼ãƒ  - æ”¹è‰¯ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- å®‰å®šç‰ˆã®AR.js -->
  <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      background: #000;
      touch-action: none;
    }
    .ui-button {
      padding: 15px 20px;
      margin: 8px;
      font-size: 18px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(145deg, #4CAF50, #45a049);
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      min-width: 140px;
      touch-action: manipulation;
      user-select: none;
      transition: all 0.2s;
    }
    .ui-button:active {
      transform: scale(0.92);
      background: linear-gradient(145deg, #45a049, #4CAF50);
    }
    .ui-button.house {
      background: linear-gradient(145deg, #2196F3, #1976D2);
    }
    .ui-button.hospital {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    .score-display {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 28px;
      color: white;
      z-index: 100;
      background: rgba(0,0,0,0.8);
      padding: 15px 25px;
      border-radius: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      border: 2px solid #fff;
    }
    .controls {
      position: fixed;
      bottom: 30px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 100;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 0 10px;
    }
    .message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      background: rgba(0,0,0,0.9);
      padding: 30px;
      border-radius: 20px;
      z-index: 200;
      border: 3px solid #fff;
      max-width: 90%;
    }
    .building-info {
      position: fixed;
      top: 100px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 90;
    }
    .debug-info {
      position: fixed;
      bottom: 120px;
      left: 20px;
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 90;
    }
  </style>
</head>
<body>

<!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
<div class="score-display">
  ğŸ† ã‚¹ã‚³ã‚¢: <span id="score">0</span>
</div>

<!-- å»ºç‰©æƒ…å ± -->
<div class="building-info" id="buildingInfo">
  ğŸ  ä½å®…: +5ç‚¹<br>
  ğŸ¥ ç—…é™¢: +10ç‚¹<br>
  ğŸŒ³ å…¬åœ’: +3ç‚¹<br>
  ğŸª åº—èˆ—: +7ç‚¹<br>
  â­ ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã‚ã‚Šï¼
</div>

<!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
<div class="debug-info" id="debugInfo">
  ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...
</div>

<!-- å»ºç‰©é¸æŠãƒœã‚¿ãƒ³ -->
<div class="controls">
  <button class="ui-button house" onclick="placeBuilding('house')">ğŸ  ä½å®… (+5)</button>
  <button class="ui-button hospital" onclick="placeBuilding('hospital')">ğŸ¥ ç—…é™¢ (+10)</button>
  <button class="ui-button" onclick="placeBuilding('park')" style="background:linear-gradient(145deg,#9C27B0,#7B1FA2)">ğŸŒ³ å…¬åœ’ (+3)</button>
  <button class="ui-button" onclick="placeBuilding('shop')" style="background:linear-gradient(145deg,#FF5722,#E64A19)">ğŸª åº—èˆ— (+7)</button>
</div>

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
<div class="message" id="message">
  <h2>ğŸ® ARè¡—ã¥ãã‚Šã‚²ãƒ¼ãƒ  ğŸ®</h2>
  <p>1. Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„</p>
  <p>2. ä¸‹ã®ãƒœã‚¿ãƒ³ã§å»ºç‰©ã‚’å»ºè¨­ï¼</p>
  <p>3. é€£ç¶šå»ºè¨­ã§ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ï¼</p>
  <br>
  <button class="ui-button" onclick="startGame()" style="padding: 12px 30px;">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
</div>

<a-scene 
  embedded 
  arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; precision: high;"
  light="defaultLightsEnabled: true;"
>

  <!-- ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚° -->
  <a-entity light="type: ambient; color: #888; intensity: 0.9"></a-entity>
  <a-entity light="type: directional; color: #FFF; intensity: 1.0; position: 2 5 3"></a-entity>

  <!-- ãƒãƒ¼ã‚«ãƒ¼ -->
  <a-marker preset="hiro" emitevents="true" id="marker" smooth="true" smoothCount="10" smoothTolerance="0.01">
    <!-- åœ°é¢ -->
    <a-plane 
      position="0 0 0" 
      rotation="-90 0 0" 
      width="4" 
      height="4" 
      color="#7CFC00"
      opacity="0.3"
    ></a-plane>
    
    <!-- å»ºç‰©ã‚³ãƒ³ãƒ†ãƒŠ - ãƒãƒ¼ã‚«ãƒ¼ã®ä¸­å¿ƒã«é…ç½® -->
    <a-entity id="buildings-container" position="0 0.1 0"></a-entity>
  </a-marker>
  
  <a-entity camera position="0 1.6 0" look-controls-enabled="false"></a-entity>
</a-scene>

<script>
let score = 0;
let comboCount = 0;
let lastPlaceTime = 0;
let totalBuildings = 0;
let isMarkerVisible = false;
const buildingPrices = {
  house: 5,
  hospital: 10,
  park: 3,
  shop: 7
};

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame() {
  document.getElementById('message').style.display = 'none';
  score = 0;
  comboCount = 0;
  totalBuildings = 0;
  updateScore();
}

// ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒå¯¾å¿œ
function setupTouchEvents() {
  const buttons = document.querySelectorAll('.ui-button');
  buttons.forEach(button => {
    button.addEventListener('touchstart', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(0.92)';
    }, { passive: false });
    
    button.addEventListener('touchend', function(e) {
      e.preventDefault();
      this.style.transform = 'scale(1)';
      // ã‚¿ãƒƒãƒ—ã—ãŸãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½ã‚’å®Ÿè¡Œ
      const type = this.getAttribute('onclick').match(/'([^']+)'/)[1];
      if (isMarkerVisible) {
        placeBuilding(type);
      } else {
        showMessage('âŒ ãƒãƒ¼ã‚«ãƒ¼ã‚’æ˜ ã—ã¦ãã ã•ã„ï¼', 0, 0);
      }
    }, { passive: false });
  });
}

// å»ºç‰©ã‚’é…ç½®
function placeBuilding(type) {
  if (!isMarkerVisible) {
    showMessage('âŒ ã¾ãšã¯ãƒãƒ¼ã‚«ãƒ¼ã‚’æ˜ ã—ã¦ãã ã•ã„ï¼', 0, 0);
    return;
  }
  
  const container = document.querySelector('#buildings-container');
  if (!container) return;
  
  const baseScore = buildingPrices[type] || 5;
  
  // ã‚³ãƒ³ãƒœåˆ¤å®šï¼ˆ3ç§’ä»¥å†…ãªã‚‰ã‚³ãƒ³ãƒœç¶™ç¶šï¼‰
  const now = Date.now();
  if (now - lastPlaceTime < 3000) {
    comboCount++;
  } else {
    comboCount = 1;
  }
  
  // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—
  let comboBonus = 0;
  if (comboCount >= 3) {
    comboBonus = Math.floor(comboCount / 3) * 5;
  }
  
  const totalPoints = baseScore + comboBonus;
  
  // ã‚¹ã‚³ã‚¢åŠ ç®—
  score += totalPoints;
  totalBuildings++;
  
  // å»ºç‰©ã‚’ä½œæˆ
  const buildingId = 'building-' + Date.now();
  const building = document.createElement('a-entity');
  building.setAttribute('id', buildingId);
  
  // å»ºç‰©ã®ç¨®é¡ã«å¿œã˜ãŸè¨­å®š
  setupBuilding(building, type, totalBuildings);
  
  container.appendChild(building);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  building.setAttribute('scale', '0.1 0.1 0.1');
  building.setAttribute('animation', {
    property: 'scale',
    to: '1 1 1',
    dur: 800,
    easing: 'easeOutElastic'
  });
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  showMessage(`ğŸ—ï¸ ${getBuildingName(type)} å®Œæˆï¼`, totalPoints, comboBonus);
  
  updateScore();
  lastPlaceTime = now;
  
  // 15ç§’å¾Œã«å»ºç‰©ã‚’å‰Šé™¤ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–ï¼‰
  setTimeout(() => {
    if (building.parentNode) {
      building.parentNode.removeChild(building);
    }
  }, 15000);
}

// å»ºç‰©ã®è¨­å®š - ä¸Šã‹ã‚‰è¦‹ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„å½¢ã«
function setupBuilding(building, type, index) {
  // ã‚°ãƒªãƒƒãƒ‰çŠ¶ã«é…ç½®ï¼ˆãƒãƒ¼ã‚«ãƒ¼ã®ä¸­å¿ƒã‹ã‚‰æ”¾å°„çŠ¶ã«ï¼‰
  const angle = (index * 137.5) % 360; // é»„é‡‘è§’ã§é…ç½®
  const radius = 1.2 + Math.floor((index - 1) / 8) * 0.8;
  const x = Math.cos(angle * Math.PI / 180) * radius;
  const z = Math.sin(angle * Math.PI / 180) * radius;
  
  building.setAttribute('position', `${x} 0 ${z}`);
  
  // å»ºç‰©ã‚’å¸¸ã«ã‚«ãƒ¡ãƒ©æ–¹å‘ã«å‘ã‘ã‚‹
  building.setAttribute('look-at', '[camera]');
  
  switch(type) {
    case 'house':
      // ä½å®… - ä¸‰è§’å±‹æ ¹ã®å®¶ï¼ˆä¸Šã‹ã‚‰è¦‹ã¦ã‚‚è­˜åˆ¥å¯èƒ½ï¼‰
      building.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.6; depth: 0.6');
      building.setAttribute('material', 'color: #2196F3; metalness: 0.3; roughness: 0.4');
      
      const roof = document.createElement('a-entity');
      roof.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.5; radiusTop: 0; height: 0.5');
      roof.setAttribute('material', 'color: #1976D2');
      roof.setAttribute('position', '0 0.55 0');
      building.appendChild(roof);
      
      // ç…™çª
      const chimney = document.createElement('a-entity');
      chimney.setAttribute('geometry', 'primitive: box; width: 0.1; height: 0.3; depth: 0.1');
      chimney.setAttribute('material', 'color: #795548');
      chimney.setAttribute('position', '0.2 0.75 0.2');
      building.appendChild(chimney);
      break;
      
    case 'hospital':
      // ç—…é™¢ - åå­—ãƒãƒ¼ã‚¯ãŒç›®å°
      building.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.8; depth: 0.8');
      building.setAttribute('material', 'color: white; metalness: 0.2; roughness: 0.3');
      
      const redCross = document.createElement('a-entity');
      redCross.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.1; depth: 0.05');
      redCross.setAttribute('material', 'color: red');
      redCross.setAttribute('position', '0 0 0.41');
      building.appendChild(redCross);
      
      const redCross2 = document.createElement('a-entity');
      redCross2.setAttribute('geometry', 'primitive: box; width: 0.1; height: 0.6; depth: 0.05');
      redCross2.setAttribute('material', 'color: red');
      redCross2.setAttribute('position', '0 0 0.41');
      building.appendChild(redCross2);
      break;
      
    case 'park':
      // å…¬åœ’ - ç·‘ã®åºƒå ´ã¨æœ¨
      building.setAttribute('geometry', 'primitive: cylinder; radius: 0.7; height: 0.05');
      building.setAttribute('material', 'color: #4CAF50');
      
      const tree1 = document.createElement('a-entity');
      tree1.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.15; radiusTop: 0; height: 0.6');
      tree1.setAttribute('material', 'color: #2E7D32');
      tree1.setAttribute('position', '0.3 0.3 0.3');
      building.appendChild(tree1);
      
      const tree2 = document.createElement('a-entity');
      tree2.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.15; radiusTop: 0; height: 0.6');
      tree2.setAttribute('material', 'color: #2E7D32');
      tree2.setAttribute('position', '-0.3 0.3 -0.3');
      building.appendChild(tree2);
      break;
      
    case 'shop':
      // åº—èˆ— - çœ‹æ¿ä»˜ã
      building.setAttribute('geometry', 'primitive: box; width: 0.7; height: 0.5; depth: 0.7');
      building.setAttribute('material', 'color: #FF5722; metalness: 0.4; roughness: 0.2');
      
      const sign = document.createElement('a-entity');
      sign.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.2; depth: 0.02');
      sign.setAttribute('material', 'color: #FFC107');
      sign.setAttribute('position', '0 0.6 0.36');
      sign.setAttribute('look-at', '[camera]');
      building.appendChild(sign);
      
      // çœ‹æ¿ã®æ–‡å­—ï¼ˆç°¡æ˜“è¡¨ç¾ï¼‰
      const signText = document.createElement('a-entity');
      signText.setAttribute('geometry', 'primitive: box; width: 0.6; height: 0.05; depth: 0.01');
      signText.setAttribute('material', 'color: #FF5722');
      signText.setAttribute('position', '0 0.6 0.38');
      building.appendChild(signText);
      break;
  }
  
  // å½±ã‚’è¿½åŠ ï¼ˆç«‹ä½“æ„Ÿå‘ä¸Šï¼‰
  const shadow = document.createElement('a-entity');
  shadow.setAttribute('geometry', 'primitive: circle; radius: 0.4');
  shadow.setAttribute('material', 'color: #000; opacity: 0.3; shader: flat');
  shadow.setAttribute('rotation', '-90 0 0');
  shadow.setAttribute('position', '0 0.01 0');
  building.appendChild(shadow);
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showMessage(text, points, comboBonus) {
  const messageDiv = document.getElementById('message');
  let bonusText = '';
  
  if (comboBonus > 0) {
    bonusText = `<br>â­ ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ +${comboBonus}ç‚¹ï¼`;
  }
  
  messageDiv.innerHTML = `
    <h3>${text}</h3>
    <p style="font-size: 24px; margin: 10px 0;">+${points} ç‚¹ç²å¾—ï¼${bonusText}</p>
    <p>ã‚³ãƒ³ãƒœ: ${comboCount}å›é€£ç¶š</p>
    <button class="ui-button" onclick="this.parentElement.style.display='none'" style="margin-top: 15px;">OK</button>
  `;
  messageDiv.style.display = 'block';
  
  // 3ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤º
  setTimeout(() => {
    if (messageDiv.style.display !== 'none') {
      messageDiv.style.display = 'none';
    }
  }, 3000);
}

function getBuildingName(type) {
  const names = {
    house: 'ä½å®…',
    hospital: 'ç—…é™¢',
    park: 'å…¬åœ’',
    shop: 'åº—èˆ—'
  };
  return names[type] || 'å»ºç‰©';
}

function updateScore() {
  document.getElementById('score').textContent = score;
  
  // ãƒ¬ãƒ™ãƒ«è¡¨ç¤º
  const level = Math.floor(score / 50) + 1;
  document.querySelector('.score-display').innerHTML = 
    `ğŸ† Lv.${level | 0} ã‚¹ã‚³ã‚¢: <span id="score">${score}</span>`;
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  setupTouchEvents();
  
  // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºæ™‚ã®å‡¦ç†
  const marker = document.querySelector('#marker');
  if (marker) {
    marker.addEventListener('markerFound', () => {
      console.log('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼èªè­˜ï¼');
      isMarkerVisible = true;
      document.getElementById('debugInfo').textContent = 'âœ… ãƒãƒ¼ã‚«ãƒ¼èªè­˜ä¸­';
      document.getElementById('debugInfo').style.background = 'rgba(0,255,0,0.8)';
    });
    
    marker.addEventListener('markerLost', () => {
      console.log('âŒ ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±');
      isMarkerVisible = false;
      document.getElementById('debugInfo').textContent = 'âŒ ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...';
      document.getElementById('debugInfo').style.background = 'rgba(255,0,0,0.8)';
    });
  }
});

// ã‚¹ãƒãƒ›ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾ç­–
document.addEventListener('touchmove', function(e) {
  e.preventDefault();
}, { passive: false });

</script>

</body>
</html>
